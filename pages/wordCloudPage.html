<div id="wordCloudPage">
    
    <h1 id="wordCloudTitle">Word Cloud Page</h1>
    
	<div id="wordCloud">
		<div id="wordCloudLoading" style="display:none"><h3 style="color:red">Loading...</h3></div>
		<svg id="wordCloudSVG"></svg>
		<canvas id="lyricsCloudCanvas" width="1200" height="500" style="display:none"></canvas>
    </div
    
    <div id="artistSearchBar"></div>
    
    <input type="button" id="search" class="button button2"  value="Search"  disabled="true" />
    
    <input type="button" id="add"  class="button button3" value="Add" disabled="true" />
    
    <input type="button" id="share" class="button button4" value="Share" disabled="true" />
    
    
    
</div>



<style>


div.relative {
    position: relative;
    width: 40px;
    height: 20px;
    border: 3px solid #73AD21;
}
h1 {
    text-align: center;
    left: 0;
    line-height: 200px;
    margin: auto;
    margin-top: -100px;
    position: absolute;
    top: 30%;
    width: 100%;
}

.button2 {
    text-align: center;
    left: 750;
    margin-top: -100px;
    position: absolute;
    top: 55%;
    
}
.button3 {
    text-align: center;
    left: 655;
    margin-top: -100px;
    position: absolute;
    top: 55%;
    
}
.button4 {
    text-align: center;
    left: 550;
    margin-top: -100px;
    position: absolute;
    top: 55%;
    
}

    </style>





<script>
		
	///
	//FUNCTIONS:
	///		
	
	// if the word is usable, return a standardized (lowercase) verison of it
	// if not, return false
	function validateWord(word) {
		word = word.toLowerCase();
		if (word.length < 3) {
			return false;
		}
		
		// TODO: exclude commonly used words
		
		return word;
	}
	
	function generateLyricsCloud() {
		
		// count words
		var words = {};
		$.each(songs, function(index, song) { // foreach song
			var songWords = song.lyrics.match(/\b[a-zA-Z']+\b/g);
			$.each(songWords, function(index, word) { // foreach word
				word = validateWord(word);
				if (word) { // if this is a word to include
					words[word] = words[word] ? words[word] + 1 : 1;
				}
			});
		});
		
		
		words = Object.keys(words).map(function(word) {
			return {text: word, size: words[word]};
		});
			
		// sort words
		words = words.sort(function(a, b) {
			return b.size - a.size;
		});
		
		// only want 250 most frequent words
		words = words.slice(0, 250);
		
		var maxSize = 80;
		var minSize = 18;
		
		var currentMax = words[0].size;
		var currentMin = words[words.length-1].size;

		$.each(words, function(key, word) {
			// scale the sizes between maxSize and minSize;
			words[key].size = (word.size - currentMin) / (currentMax - currentMin) * (maxSize - minSize) + minSize;
		});
		
		// these colors will be chosen from randomly
		var colors = ["red", "blue", "green", "orange", "purple"];
		
	    d3.layout.cloud().size([1200, 500])
		  .words(words)
		  .padding(5)
		  .rotate(function() { return 0; })
		  .spiral("rectangular")
		  //.font("Impact")
		  .fontSize(function(d) { return d.size; })
		  .on("end", function (words) {
		  
				$("#wordCloudLoading").hide(0);
		  
				// draw in the svg tag
			  d3.select("#wordCloudSVG")
				.attr("width", 1200)
				.attr("height", 500)
			  .append("g")
				.attr("transform", "translate(600,250)")
			  .selectAll("text")
				.data(words)
			  .enter().append("text")
				.style("font-size", function(d) { return d.size + "px"; })
				.style("font-family", "serif")
				.style("fill", function(d, i) { return colors[Math.floor(Math.random() * colors.length)]; })
				.attr("text-anchor", "middle")
				.attr("transform", function(d) {
				  return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
				})
				.text(function(d) { return d.text; })
				.on("click", function(d, i) {
					word = d.text;
					loadPage("songList");
				});
				
				// draw in the canvas tag
				canvg('lyricsCloudCanvas', $("#wordCloudSVG").html());
				
				$("#share").removeProp("disabled");
		  })
		  .start();
	}
	
	// call this function when the page first loads, then whenever the artist list changes
	function setTitle() {
		// Set the title (of document and header)
		var title = ""
		$.each(artists, function(index, artist) {
			title += ", " + artist.name;
		});
		title = title.substring(2);
		
		document.title = title;
		$("#wordCloudTitle").text(title);
	}
	
	// Call this function when the page first loads and then whenever an artist is searched/added
	function queryArtists(artistsToQuery) {
	
		setTitle();
	
		// TODO: set a good loading animation (like a spinning wheel)
		$("#wordCloudLoading").show(0);
		$("#share").attr("disabled", true);
			
		// Make the parameter object
				
		var ids = [];
		$.each(artistsToQuery, function(key, value) {
			ids.push(value.chartLyricsID);
		})
			
		// Load the lyrics and generate the word cloud
		$.ajax({ // Load artist lyrics
			url: "ajax/artistSongs.php",
			data: {ids: ids},
			dataType: "json",
			success: function(data) {
				
				// save the results
				$.each(data, function(index, song) {
					songs.push(song);
				})
				
				generateLyricsCloud()
			}
		});
	}
	
	// Call this function when the page first loads and then whenever an artist searched
	function searchArtists(a) {
		
		artists = a;
		songs = [];
		
		queryArtists(a);
	}

	// Call this function whenever an artist is added
	function addArtist(a) {
	
		// Don't add an artist that we already have
		if ($.inArray(a, artists) >= 0) {
			return;
		}
	
		artists.push(a);
		
		queryArtists([a]);
	}
	
	//
	// Post the image to Facebook!
	//
	// @param authToken: the FB authToken to use
	//
	function shareWordCloud(authToken) {
		
		var c = document.getElementById('lyricsCloudCanvas').toDataURL('image/png');
		var encodedPng = c.substring(c.indexOf(',')+1,c.length);
		var imageData = Base64Binary.decode(encodedPng);
		
		var caption = 'I used Lyrics Cloud to make this cloud for the artist(s): ' + $("#wordCloudTitle").text() + "!";
		
		postImageToFacebook(authToken, 'lyricsCloud.png', 'image/png', caption, imageData)
	}
	
	///
	//ON LOAD:
	///
	
	// Initialize the lyrics cloud
	if (songs.length > 0) { // we're coming back to this page
		setTitle();
		generateLyricsCloud();
	} else { // first time to this page
		searchArtists(artists);
	}
	
	// Set up the Artist Search Bar
	$("#artistSearchBar")
		.load("components/artistSearchBar.html")
		.on("yesSelection", function() {		
			$("#search").removeProp("disabled");
			$("#add").removeProp("disabled");
		})
		.on("noSelection", function() {
			$("#search").attr("disabled", true);
			$("#add").attr("disabled", true);
		});

	// Set up the Search Button
	$('#search').click(function() {
		
		$("#artistSearchBar").trigger('clear');
		
		var artistID = $("#artistSearchBar").attr("value");
		searchArtists([allArtists[artistID]]);
	});
	
	// Set up the Add Button
	$('#add').click(function() {
		
		$("#artistSearchBar").trigger('clear');
		
		var artistID = $("#artistSearchBar").attr("value");
		addArtist(allArtists[artistID]);
	});

	
	// Set up the Share Button
	$("#share").click(function() {
				
		FB.getLoginStatus(function(response) { // Check if the user is already logged in
			 			 
			 if (response.status === 'connected') {
				shareWordCloud(response.authResponse.accessToken);
			 } else {
				FB.login(function(response) { // Prompt Facebook login
					FB.getLoginStatus(function(response) { // Check if the user successfully logged in
						 
						 if (response.status === 'connected') {
							shareWordCloud(response.authResponse.accessToken);
						 }
						 
						 // If the user didn't log in, then forget about it!
					});
				}, {scope: 'public_profile,email,publish_actions'});
			}
		});
		
	});
	
	// Draw a placeholder image in the lyrics cloud canvas
	$(function() {
		var c = document.getElementById("lyricsCloudCanvas");
		var ctx = c.getContext("2d");
		ctx.beginPath();
		ctx.arc(95,50,40,0,2*Math.PI);
		ctx.stroke();	
	});
		
</script>
